## Rule Mapping v2.5 — Spotify Search 기반 추천 규칙 매핑표

파일: rule_mapping__v2.5.csv
최종 업데이트: 2025.11.04

# 1. 개요

이 파일은 위치(Location), 소음(Decibel), 목표(Goal) 데이터를 기반으로
사용자 상황에 가장 적합한 음악을 추천하기 위한 규칙 기반 매핑표입니다.

Spotify API 권한 제한으로 Spotify의 AI 추천(/recommendations)대신
자체 규칙(rule-based mapping)을 기반으로 검색 기반(/search) 추천 전략을 적용했습니다.
즉, 각 조합별로 Spotify에서 바로 검색 가능한 query와 **링크(URL)**를 생성합니다.

# 2. 파일 구성

| 컬럼명 | 설명 |
|--------|------|
| `location` | 사용자의 위치 (예: cafe, library, office, home, outdoor, subway) |
| `db_band` | 소음 구간 (예: 36–50, 51–65, 66–80, 81+) |
| `goal` | 사용자의 심리적 목표 (focus, relax, active, reading, meditate, sleep, neutral) |
| `bpm_min` / `bpm_max` | 음악 템포 범위 (beats per minute) |
| `energy_min` / `energy_max` | 음악의 에너지 강도 (0.0~1.0) |
| `mood` | 음악의 정서적 분위기 (calm / chill / energetic / serene 등) |
| `genre_primary` / `genre_secondary` | 주요 장르 키워드 (lo-fi, jazz, edm 등) |
| `vocal` | 보컬 비율 (instrumental / light-vocal / no-vocal / vocal-heavy) |
| `search_query` | Spotify 검색 엔진에 최적화된 자연어 기반 검색어 |
| `search_url` | Spotify 웹에서 바로 열리는 검색 링크 (`https://open.spotify.com/search/...`) |


# 3. 검색어 생성 로직 요약 (make_search_query_v2)
모든 행은 다음 규칙으로 검색어(search_query)를 구성합니다:
genre_primary + genre_secondary + [vocal 필터] + mood + [에너지 힌트] + [Goal 자연어 표현] + [BPM 힌트]

*장르삽입규칙*
| 조건                                        | 검색어 구성 방식                                   | 예시                                                               | 설명                                                                |
| ----------------------------------------- | ------------------------------------------- | ---------------------------------------------------------------- | ----------------------------------------------------------------- |
| **기본형**: 장르가 하나만 지정된 경우                   | `[genre_primary] + ...`                     | `lo-fi instrumental calm for focus 80-90 bpm -live -remix`       | 단일 장르 중심. `secondary` 값이 비어있으면 생략.                                |
| **확장형**: 2차 장르(`genre_secondary`)가 존재할 경우 | `[genre_primary] + [genre_secondary] + ...` | `pop edm light-vocal upbeat for active 110-120 bpm -live -remix` | 2차 장르가 서브톤 또는 리듬 계열을 보완함 (예: pop + edm, jazz + soul).             |
| **예외형 (유사계열)**                            | 하나의 장르만 유지                                  | `ambient instrumental calm for relax 65-75 bpm`                  | primary와 secondary가 같은 계열(ex. chill / ambient)이면 중복 방지 위해 하나만 사용. |


*[vocal 필터] 삽입 규칙*
| 조건                                                       | 검색어에 포함 여부  | 예시                                                         | 설명                              |
| -------------------------------------------------------- | ----------- | ---------------------------------------------------------- | ------------------------------- |
| **비보컬형 (`instrumental`)**                                | **포함됨**     | `lo-fi instrumental calm for focus 80-90 bpm -live -remix` | 완전 비보컬. “instrumental” 키워드로 명시. |
| **보컬 강조형 (`vocal-heavy`, `female-vocal`, `male-vocal`)** | **간단히 포함됨** | `pop female-vocal upbeat for active 110-120 bpm`           | 특정 보컬톤이 곡 분위기에 영향을 주는 경우.       |
| **중립형 (`light-vocal`, `balanced`)**                      | **생략됨**     | `jazz soul chill for relax 70-80 bpm`                      | 보컬 존재하되, 핵심 속성이 아니므로 생략.        |
| **불명확 / N/A**                                            | **생략됨**     | `ambient calm for sleep 60-70 bpm`                         | 보컬 속성 자체가 무의미하거나 데이터 없음.        |


*[에너지 힌트] 삽입 규칙*
에너지 힌트는 항상 존재하지 않고, Mood·Goal이 에너지를 이미 표현하는 경우 자동 생략
| 에너지 구간 (`energy_min ~ energy_max`) | 삽입 키워드                           | 예시                                          | 의미                     |
| ---------------------------------- | -------------------------------- | ------------------------------------------- | ---------------------- |
| **0.0 ~ 0.3**                      | `soft`, `slow`, `peaceful`       | `piano soft calm for sleep 60-70 bpm`       | 매우 조용하거나 느린 곡 (수면·명상용) |
| **0.31 ~ 0.5**                     | `mellow`, `gentle`, `smooth`     | `jazz mellow chill for relax 70-80 bpm`     | 부드럽고 따뜻한 중간 텐션         |
| **0.51 ~ 0.7**                     | `energetic`, `bright`, `groovy`  | `pop bright happy for active 100-110 bpm`   | 명랑하고 리듬감 있는 상태         |
| **0.71 이상**                        | `intense`, `powerful`, `workout` | `edm intense upbeat for active 120-130 bpm` | 빠르고 강한 활동성 중심 (운동, 집중) |


예시:
| Goal         | search_query 예시                                            | 의미                 |
| ------------ | ---------------------------------------------------------- | ------------------ |
| **focus**    | `lo-fi instrumental calm for focus 80-90 bpm -live -remix` | 집중용, 조용한 무보컬 Lo-Fi |
| **relax**    | `jazz acoustic chill to relax 60-75 bpm`                   | 휴식용, 부드러운 어쿠스틱 재즈  |
| **active**   | `edm pop energetic workout music 110-120 bpm`              | 활동용, 에너지 높은 음악     |
| **meditate** | `ambient drone meditation music 55-60 bpm`                 | 명상용, 반복적 저주파 사운드   |
| **sleep**    | `ambient white noise sleep sounds 55 bpm`                  | 수면 유도용, 화이트노이즈 중심  |


# 4. 목표(Goal) 자연어 매핑
| Goal     | Spotify 자연어 표현     | 설명                 |
| -------- | ------------------ | ------------------ |
| focus    | `for focus`        | 집중용, Deep Focus 계열 |
| reading  | `study music`      | 독서/공부 배경음          |
| relax    | `to relax`         | 휴식/이완              |
| active   | `workout music`    | 운동/활동              |
| meditate | `meditation music` | 명상/호흡              |
| sleep    | `sleep sounds`     | 수면 유도용             |
| neutral  | `background music` | 기본형 (fallback)     |



# 5. 개발자 노트

rule_mapping_v1.csv → 기본 규칙 (BPM/Energy/Mood/Genre/Vocal)으로 platlist_seed(Genre/mood/goal반영)

rule_mapping_v1.csv → search_query로 변경(Genre/mood/Vocal/BPM 반영)

rule_mapping__v2.5.csv → search_query 검색 기반 최적화 버전 (에너지힌트, Spotify 자연어 쿼리 반영)

파일 인코딩: utf-8-sig

# 6. 버전 이력

| 버전       | 내용                                             | 작성일            |
| -------- | ---------------------------------------------- | -------------- |
| v1.0     | 규칙 기반 매핑 (단순 문자열 seed)                         | 2025-10        |
| v2.0     | 검색형 쿼리 자동 생성 (make_search_query)             | 2025-11        |
| **v2.5** | Spotify 감성형 자연어 쿼리, 불필요 토큰 제거 (-live/-remix 등) | **2025-11-04** |

# 9. 변환 스크립트
build_search_query_v2.py :  rule_mapping_v1.csv → search_query 생성

build_search_query_v2.5.py : rule_mapping_v1.csv → Spotify 자연어형 search_query 생성
1. 에너지 힌트 생성
2. 불필요 결과 제거 토큰 자동 추가: 필터 4종(-live -remix -karaoke -cover )
3. search_url(open.spotify.com/search/…) 자동 생성

*스크립트 실행 코드*
cd c:\Users\seonu\Documents\soundscape_project\rule_mapping
C:/Users/seonu/AppData/Local/Programs/Python/Python313/python.exe build_search_query_v2.5.py
